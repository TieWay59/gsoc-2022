# Week-03 工作笔记

> notes will be translated into English and inclueded in my weekly blog.

## SirMorded 文件结构注释

```bash
# this is generated by `tree` command.
.
├── bin
│   └── sirmordred.py                   # 运行入口之一，只处理参数（-c -t -p），调用根目录下的 `from sirmordred.sirmordred import SirMordred`。 包含在 `pyproject.toml - [tool.poetry.scripts]`
├── config.py                           # 包含重要的 `setup.cfg` 的配置简介，以及创建与读取配置文件的方法
├── error.py
├── github.py                           # 提供爬取 GitHub 中文件的方法
├── __init__.py
├── __pycache__                         # 存放解释器编译的字节码
│   ├── config.cpython-310.pyc
│   └── ...
├── sirmordred.py                       # 程序主体类，方法主要调用随后的所有 task
├── task_collection.py                  #
├── task_enrich.py                      #
├── task_identities.py                  #
├── task_manager.py                     #
├── task_panels.py                      #
├── task_projects.py                    #
├── task.py                             # 所有 task 的父类
├── utils
│   ├── find_affiliation_conflicts.py   # 独立的脚本程序，用于寻找所属组织的冲突
│   ├── grimoirelab_valid.yml           # 不知道什么用途的 yml 数据
│   ├── healthcheck.py                  # 独立的脚本程序，提供查询log中报错信息的途径。包含在 `pyproject.toml - [tool.poetry.scripts]`
│   ├── micro.py                        # 是一个方便测试的脚本程序，相对于 sirmordred.py 完整执行项目，micro.py 可以用参数决定只执行哪些task 便于测试。 包含在 `pyproject.toml - [tool.poetry.scripts]`
│   ├── panels_config.py                # 这个脚本允许上传 setup.cfg 和顶部菜单中使用的仪表盘。它依赖于任务面板和任务面板菜单类。看主函数可以看动在干什么。 包含在 `pyproject.toml - [tool.poetry.scripts]`
│   ├── projects.json
│   ├── projects_json2yml.py            # Convert JSON to YML: return hierarchy.yml and projects_repo.yml 不知道有什么用
│   └── setup.cfg                       #
└── _version.py
```

## setup.cfg 文件

想要了解这个文件有哪些配置项，可以阅读代码：`grimoirelab-sirmordred/sirmordred/config.py` （Edit：后来我才意时到其实 `grimoirelab-sirmordred/README.md` 介绍的很清楚了）

特别是后端的部分介绍的非常详细：

配置选项是通过 INI 文件设置的，该文件有几个部分，如`[gitlab]`，称为基本 backend 部分，以及`[gitlab:issue]`或`[gitlab:ieee]`等部分，称为参数化 backend 部分。

## PYTHONPATH 问题

[python 3.x - Able to start module in terminal but not with PyCharm's run config - Stack Overflow](https://stackoverflow.com/questions/70555130/able-to-start-module-in-terminal-but-not-with-pycharms-run-config)

Pycharm run Configuration 的这两个选项会有概率导致模块读取失败。

- [ ] Add content roots to PYTHONPATH
- [ ] Add source roots to PYTHONPATH

> PYTHONPATH 是一个环境变量，您可以将其设置为添加附加目录，python 将在其中查找模块和包。对于大多数安装，您不应该设置这些变量，因为 Python 不需要它们来运行。Python 知道在哪里可以找到它的标准库。设置 PYTHONPATH 的唯一原因是维护不希望安装在全局默认位置（即 site packages 目录）的自定义 Python 库的目录。

## 尝试安装 Gitee

实际上 sirmordred 依赖的包都是直接安装到虚拟环境中调用，一种方式是使用 `requirements.txt`，另一种是使用 `poetry & pyproject.toml`。但我印象中我可能错误地把两种方式都安装过，导致了后续的一些无法确定的错误。

最初的教程是让我下载所有的十几个仓库，但现在还不知道怎么样建立了关联，因为自动会把 `grimoirelab_elk` 对应到本地克隆到的库。

我的理解是在某一步骤，这些克隆到本地的库其实已经安装到环境中了。

下面要安装 gitee 的办法也不复杂，把对应的几个仓库依赖拉进来，然后把配置文件拉进来就可以了。从步骤上看，似乎更喜欢直接用 sirmordred 本体项目编译运行。我需要把项目配置几个文件拉到 sirmordred 所在的目录下。

[How to run grimoirelab gitee? · grimoirelab-gitee/grimoirelab Wiki](https://github.com/grimoirelab-gitee/grimoirelab/wiki/How-to-run-grimoirelab-gitee%3F)

按照这个文档的说法，只要在现有的 vlen 中安装（或者替换）以下几个模块：

```BASH
perceval-gitee      0.1.0     /root/repos/grimoirelab-perceval-gitee
grimoire-elk        0.86.0    /root/repos_grimoirelab/grimoireelk
grimoire-elk-gitee  0.1.0     /root/repos_grimoirelab/grimoirelab-elk-gitee
grimoirelab-panels  0.0.60    /root/repos_grimoirelab/sigils
```

其中 grimoire-elk & grimoirelab-panels 要做卸载替换。

我发现 grimoire-elk & grimoirelab-panels 在现在的版本里是没有的，结合之前我的失误，我确定是环境安装的问题。在此时我发现我直接的运行是行不通的，那么最好的解决办法是重新安装环境。

下周我会详细记录我如何重装环境并且整合到 gitee 的数据源。
